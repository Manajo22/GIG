<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Body-Star Catcher</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    html,body{height:100%;margin:0;background:#27114C;color:#fff;font-family:'Fredoka',system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    #app{position:fixed;inset:0;overflow:hidden;background:#27114C;display:flex;flex-direction:column;align-items:center;padding:20px;}
    
    .title{font-size:32px;font-weight:400;color:#fff;text-align:center;margin-bottom:20px;}
    
    .game-container{
      width:100%;
      max-width:400px;
      aspect-ratio:3/4;
      background:#000000;
      border-radius:20px;
      position:relative;
      overflow:hidden;
      flex:1;
      max-height:calc(100vh - 120px);
    }
    
    video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1);opacity:0.6;background:#D1D5DB;}
    canvas{position:absolute;inset:0;width:100%;height:100%;}
    
    .hud{position:absolute;top:10px;left:10px;right:10px;display:flex;align-items:center;justify-content:space-between;pointer-events:none}
    .pill{background:rgba(0,0,0,.7);padding:6px 12px;border-radius:999px;font-weight:300;font-size:14px;}
    
    .btnbar{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(209,213,219,0.9);}
    button{pointer-events:auto;appearance:none;background:#27114C;color:#fff;border:none;border-radius:50px;padding:16px 24px;font-size:18px;font-weight:300;cursor:pointer;font-family:'Fredoka';}
    button:hover{background:#553C9A;}
    
    .status{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;background:rgba(0,0,0,0.8);padding:20px;border-radius:16px;font-weight:300;}
    .tracker{position:absolute;inset:10px;border:2px dashed rgba(107,70,193,0.6);pointer-events:none;border-radius:10px;}
    
    .stars{position:absolute;top:10px;left:35px;right:35px;pointer-events:none;display:flex;justify-content:space-between;}
    .star-decoration{font-size:24px;opacity:0.8;}
  </style>
</head>
<body>
  <div id="app">
    <div class="title">Catch the stars</div>
    <div class="stars">
      <div class="star-decoration">⭐</div>
      <div class="star-decoration">⭐</div>
    </div>
    
    <div class="game-container">
      <video id="video" playsinline autoplay muted></video>
      <canvas id="canvas"></canvas>
      <div class="tracker" id="tracker" style="display:none"></div>

      <div class="hud">
        <div class="pill">Score: <span id="score">0</span> / 5</div>
      </div>

      <div class="btnbar" id="gate">
        <button id="start">Start Game</button>
      </div>

      <div class="status" id="status" style="display:none">
        <div id="statusMsg">Position yourself in the frame</div>
      </div>
    </div>
  </div>

  <script type="module">
    const isMobile = window.innerWidth < 768;
    let starRadius = isMobile ? 18 : 25;

    import {
      FilesetResolver,
      PoseLandmarker
    } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.12/vision_bundle.mjs";

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('start');
    const scoreEl = document.getElementById('score');
    const statusEl = document.getElementById('status');
    const statusMsg = document.getElementById('statusMsg');
    const gate = document.getElementById('gate');
    const tracker = document.getElementById('tracker');
    const gameContainer = document.querySelector('.game-container');

    let landmarker;
    let game = { mode:'idle', star:null, collected:0, maxStars:5 };

    function resize(){
      const rect = gameContainer.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener('resize',resize);
    
    function spawnStar(){
      const rect = gameContainer.getBoundingClientRect();
      const w = rect.width;
      const h = rect.height;
      const margin = 40;
      const r = starRadius;
      const edges = ['top','right','bottom','left'];
      const edge = edges[Math.floor(Math.random()*edges.length)];
      let x,y;
      if(edge==='top'){x=Math.random()*(w-2*margin)+margin;y=margin;}
      if(edge==='bottom'){x=Math.random()*(w-2*margin)+margin;y=h-margin;}
      if(edge==='left'){x=margin;y=Math.random()*(h-2*margin)+margin;}
      if(edge==='right'){x=w-margin;y=Math.random()*(h-2*margin)+margin;}
      game.star={x,y,r};
    }

    function drawStar(x, y) {
      ctx.save();
      ctx.translate(x, y);
      ctx.fillStyle = '#FFD700';
      ctx.shadowColor = '#FFD700';
      ctx.shadowBlur = 15;

      ctx.beginPath();
      const spikes = 5;
      const outer = starRadius;
      const inner = starRadius * 0.5;

      let rot = Math.PI / 2 * 3;
      let cx = 0, cy = 0;

      ctx.moveTo(cx, cy - outer);

      for (let i = 0; i < spikes; i++) {
        cx = Math.cos(rot) * outer;
        cy = Math.sin(rot) * outer;
        ctx.lineTo(cx, cy);
        rot += Math.PI / 5;

        cx = Math.cos(rot) * inner;
        cy = Math.sin(rot) * inner;
        ctx.lineTo(cx, cy);
        rot += Math.PI / 5;
      }

      ctx.lineTo(0, -outer);
      ctx.closePath();
      ctx.fill();
      ctx.restore();
    }

    function isTorsoVisible(landmarks){
      if(!landmarks||landmarks.length<23) return false;
      const nose=landmarks[0];
      const hip=landmarks[23];
      return nose && hip && nose.y<hip.y*0.9;
    }

    function drawHands(lm){
      const rect = gameContainer.getBoundingClientRect();
      const w = rect.width;
      const h = rect.height;
      const L=(i)=>({x:w - (lm[i].x*w), y:lm[i].y*h});
      const left=L(20), right=L(19);
      [left,right].forEach(p=>{
        ctx.beginPath();ctx.arc(p.x,p.y,16,0,Math.PI*2);
        ctx.fillStyle='rgba(107,70,193,0.8)';ctx.fill();
      });
      return {left,right};
    }

    function handsTouchStar(hands){
      if(!game.star) return false;
      const {x,y,r}=game.star;
      const touchR=r+25;
      const d2=(p)=> (p.x-x)**2+(p.y-y)**2;
      return d2(hands.left)<touchR**2 || d2(hands.right)<touchR**2;
    }

    async function init(){
      const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false});
      video.srcObject=stream; await video.play();
      resize();

      const vision=await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.12/wasm");
      landmarker=await PoseLandmarker.createFromOptions(vision,{
        baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task",delegate:'GPU'},
        runningMode:'VIDEO',numPoses:1
      });

      game.mode='positioning'; 
      statusEl.style.display='block'; 
      tracker.style.display='block';
      requestAnimationFrame(loop);
    }

    function loop(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      let landmarks=null;
      if(landmarker&&video.readyState>=2){
        const res=landmarker.detectForVideo(video,performance.now());
        if(res&&res.landmarks.length>0){landmarks=res.landmarks[0];}
      }

      if(game.mode==='positioning'){
        const ok=isTorsoVisible(landmarks);
        statusMsg.textContent=ok?'Starting...':'Position yourself in the frame';
        if(ok){
          setTimeout(()=>{if(game.mode==='positioning'){game.mode='playing';statusEl.style.display='none';tracker.style.display='none';spawnStar();}},700);
        }
      }

      if(game.mode==='playing'){
        if(!game.star) spawnStar();
        drawStar(game.star.x,game.star.y,game.star.r);
        const hands=drawHands(landmarks);
        if(handsTouchStar(hands)){
          game.collected++;scoreEl.textContent=game.collected;
          game.star=null;
          if(game.collected>=game.maxStars){game.mode='finished';}
        }
      }

      if (game.mode === 'finished') {
        ctx.fillStyle = '#27114C';
        ctx.font = '36px Fredoka';
        ctx.textAlign = 'center';
        ctx.shadowColor = '#27114C';
        ctx.shadowBlur = 10;
        const rect = gameContainer.getBoundingClientRect();
        ctx.fillText(' Complete! ', rect.width / 2, rect.height / 2);

        ctx.shadowBlur = 0;
        ctx.font = '18px Fredoka';
        ctx.fillText('Tap to restart', rect.width / 2, rect.height / 2 + 40);
      }

      requestAnimationFrame(loop);
    }

    canvas.addEventListener('click',()=>{
      if(game.mode==='finished'){
        game.collected=0;
        scoreEl.textContent=0;
        game.mode='positioning';
        statusEl.style.display='block';
        tracker.style.display='block';
      }
    });

    startBtn.addEventListener('click',async()=>{
      startBtn.disabled=true;
      try{
        await init();
        gate.style.display='none';
      }catch(e){
        alert('Camera access needed to play');
        startBtn.disabled=false;
      }
    });
  </script>
</body>
</html>